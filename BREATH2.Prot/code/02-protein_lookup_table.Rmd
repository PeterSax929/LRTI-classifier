---
title: "02-protein_lookup_table"
output: html_notebook
toc: true
---

```{r}
#| warning: false






# 2.1. Prepare Seq ids


library(dplyr)
library(SomaScan.db)
library(SomaDataIO)
library(AnnotationDbi)  
library(tibble)

# Set file path
data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Prot/data"

protein_mat_PROBEID <- read.csv(
  file.path(data_dir, "protein_mat_PROBEID.csv"), 
  stringsAsFactors=F, check.names=F)

# Extracts all PROBEIDs in protein_mat_ALL
seq_ids <- colnames(protein_mat_PROBEID)






# 2.2. Build protein lookup table


# Build table
protein_lookup_table_ALL <- SomaScan.db::select(
  SomaScan.db,
  keys = seq_ids,
  keytype = "PROBEID",
  columns = c("PROBEID", "SYMBOL", "GENENAME", "UNIPROT")
)

#Remove duplicates
protein_lookup_table_ALL <- protein_lookup_table_ALL %>% distinct(PROBEID, .keep_all=T)






# 2.2a. Collect unmapped probes


# Removes unannotated PROBEIDs
protein_lookup_table_ALL <- protein_lookup_table_ALL %>%
  filter(!is.na(SYMBOL)) %>%
  arrange(SYMBOL)

# All valid PROBEIDs in the package
valid_ids <- keys(SomaScan.db, keytype = "PROBEID")

# Find unmapped probes
unmapped_probes <- setdiff(seq_ids, valid_ids)

# Write csv
write.csv(data.frame(PROBEID = unmapped_probes), 
          file.path(data_dir, "unmapped_probes.csv"), 
          row.names=F)






# 2.2b. Take mean expression for PROBEIDs


# Keep only annotated probes
protein_mat_PROBEID <- protein_mat_PROBEID[, colnames(protein_mat_PROBEID) %in% protein_lookup_table_ALL$PROBEID]

# Reorder lookup table to match the columns in protein_mat_ALL
protein_lookup_table_ALL <- protein_lookup_table_ALL[match(colnames(protein_mat_PROBEID), protein_lookup_table_ALL$PROBEID), ]

# Confirm alignment
stopifnot(all(colnames(protein_mat_PROBEID) == protein_lookup_table_ALL$PROBEID))

# Collapse duplicate probes (mean expression per SYMBOL)
protein_mat_PROBEID_t <- t(protein_mat_PROBEID) %>%
  as.data.frame() %>%
  mutate(SYMBOL = protein_lookup_table_ALL$SYMBOL) %>%
  group_by(SYMBOL) %>%
  summarise(across(everything(), mean, na.rm=T)) %>%
  as.data.frame()

# Restore to original shape
rownames_tmp <- protein_mat_PROBEID_t$SYMBOL






# 2.2c. Align tables


# Define protein_mat_ALL
protein_mat_ALL <- as.data.frame(t(protein_mat_PROBEID_t[, -1]))
colnames(protein_mat_ALL) <- rownames_tmp
rownames(protein_mat_ALL) <- patients_vector


# Remove duplicate SYMBOLs in lookup table to match collapsed matrix
protein_lookup_table <- protein_lookup_table_ALL %>%
  filter(SYMBOL %in% colnames(protein_mat_ALL)) %>%
  distinct(SYMBOL, .keep_all=T)

# Match lookup table order to protein_mat_ALL column order
protein_lookup_table <- protein_lookup_table[match(colnames(protein_mat_ALL),
                                                   protein_lookup_table$SYMBOL), ]

# Write csvs
write.csv(protein_lookup_table, 
          file.path(data_dir, "protein_lookup_table.csv"),
          row.names=F)

write.csv(protein_mat_ALL, 
          file.path(data_dir, "protein_mat_ALL.csv"), 
          row.names=T)






# 2.3. Safety Check


length(unmapped_probes)

nrow(protein_lookup_table) # Should be 6346

# Check for duplicate symbols 
any(duplicated(colnames(protein_mat_ALL)))  # Should return FALSE

# Confirm lengths match
length(colnames(protein_mat_ALL))  # Should be 6346
length(protein_lookup_table$SYMBOL)  # SHould be 6346

# How many symbols actually overlap
sum(colnames(protein_mat_ALL) %in% protein_lookup_table$SYMBOL)  # Should be 6346






```