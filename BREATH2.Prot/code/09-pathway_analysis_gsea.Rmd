---
title: "09-pathway_analysis_gsea"
output: html_notebook
toc: true
---

```{r}
#| warning: false


library(clusterProfiler)
library(msigdbr)
library(org.Hs.eg.db)
library(dplyr)
library(ggplot2)
library(enrichplot)
library(stringr)






# 9.1. Import data


# Set file paths

results_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Prot/results"

res_df <- read.csv(
  file.path(results_dir, "DA_results_proteomics.csv"),
  stringsAsFactors=F)






# 9.2. Ranked Proteins List


# Use protein IDs and log2FC
protein_ranks <- res_df$log2FoldChange
names(protein_ranks) <- res_df$gene

# Sort decreasing 
protein_ranks <- sort(protein_ranks, decreasing=T)

# protein_ranks is a named numeric vector
protein_ranks_df <- data.frame(
  gene = names(protein_ranks),
  log2FC = as.numeric(protein_ranks)
)

write.csv(
  protein_ranks_df,
  file.path(results_dir, "protein_ranks_for_RNA_GSEA.csv"),
  row.names=F)






# 9.3. Hallmark GSEA


hallmark_sets <- msigdbr(
  species  = "Homo sapiens",
  category = "H"
) %>%
  dplyr::select(gs_name, gene_symbol)

gsea_hallmark_prot <- GSEA(
  geneList  = protein_ranks,
  TERM2GENE = hallmark_sets,
  pvalueCutoff = 0.05,
  eps = 0,
  verbose = FALSE
)

hallmark_df_prot <- as.data.frame(gsea_hallmark_prot)

write.csv(
  hallmark_df_prot,
  file.path(results_dir, "GSEA_Hallmark_proteome.csv"),
  row.names=F)






# 9.4. Reactome GSEA


reactome_sets <- msigdbr(
  species     = "Homo sapiens",
  category    = "C2",
  subcategory = "CP:REACTOME"
) %>%
  dplyr::select(gs_name, gene_symbol)

gsea_reactome_prot <- GSEA(
  geneList  = protein_ranks,
  TERM2GENE = reactome_sets,
  pvalueCutoff = 0.05,
  verbose = FALSE
)

reactome_df_prot <- as.data.frame(gsea_reactome_prot)

write.csv(
  reactome_df_prot,
  file.path(results_dir, "GSEA_Reactome_proteome.csv"),
  row.names=F)






# 9.5. Hallmark Pathway Plots


# View top Hallmark pathways by NES
gsea_hallmark_prot@result %>%
  filter(p.adjust < 0.05) %>%
  arrange(desc(abs(NES))) %>%
  dplyr::select(ID, Description, NES, p.adjust) %>%
  head(10)

# IFNγ
p_ifng_prot <- gseaplot2(
  gsea_hallmark_prot,
  geneSetID = "HALLMARK_INTERFERON_GAMMA_RESPONSE",
  title = "Protein Hallmark IFNγ Response",
  base_size = 12,
  subplots = c(1,2,3))

ggsave(
  file.path(results_dir, "GSEA_IFNG_protein.png"),
  p_ifng_prot,
  width = 7,
  height = 6,
  dpi = 300
)

# IFNα
p_ifna_prot <- gseaplot2(
  gsea_hallmark_prot,
  geneSetID = "HALLMARK_INTERFERON_ALPHA_RESPONSE",
  title = "Protein Hallmark IFNα Response",
  base_size = 12,
  subplots = c(1,2,3))

# Print plots
p_ifng_prot
p_ifna_prot

# Save plots
ggsave(
  file.path(results_dir, "GSEA_IFNG_protein.png"),
  p_ifng_prot,
  width = 7,
  height = 6,
  dpi = 300
)

ggsave(
  file.path(results_dir, "GSEA_IFNA_protein.png"),
  p_ifna_prot,
  width = 7,
  height = 6,
  dpi = 300
)






# 9.6. Reactome Pathway Plot


# View top Reactome pathways
gsea_reactome_prot@result %>%
  filter(p.adjust < 0.05) %>%
  arrange(desc(abs(NES))) %>%
  dplyr::select(ID, Description, NES, p.adjust) %>%
  head(10)

p_reactome_digest_prot <- gseaplot2(
  gsea_reactome_prot,
  geneSetID = "REACTOME_DIGESTION",
  title = "Protein Reactome: Digestion",
  base_size = 12,
  subplots = c(1, 2, 3))

# Print plot
p_reactome_digest_prot

# Save plot
ggsave(
  filename = file.path(results_dir, "GSEA_Reactome_Digestion_protein.png"),
  plot = p_reactome_digest_prot,
  width = 7,
  height = 6,
  dpi = 300
)






# 9.7. Hallmark GSEA summary dot plot


# Prepare Hallmark plot data
hallmark_plot_prot_df <- gsea_hallmark_prot@result %>%
  filter(p.adjust < 0.05) %>%
  mutate(
    neglogPadj = -log10(p.adjust),
    Direction = ifelse(NES > 0, "Up", "Down")
  )

# Top 8 Up
hallmark_top_up_prot <- hallmark_plot_prot_df %>%
  filter(NES > 0) %>%
  arrange(desc(NES)) %>%
  slice_head(n = 8)

# Top 8 Down
hallmark_top_down_prot <- hallmark_plot_prot_df %>%
  filter(NES < 0) %>%
  arrange(NES) %>%
  slice_head(n = 8)

hallmark_top16_prot <- bind_rows(hallmark_top_up_prot, hallmark_top_down_prot) %>%
  mutate(
    Description = gsub("^HALLMARK_", "", Description),
    Description = gsub("_", " ", Description),
    Description = str_wrap(Description, width = 20),
    Description = factor(Description, levels = Description[order(NES)])
  )

# Plot
p_hallmark_all_prot <- ggplot(
  hallmark_top16_prot,
  aes(y = Description, x = NES)
) +
  geom_vline(xintercept = 0, linewidth = 0.8, color = "black") +
  geom_segment(aes(x = 0, xend = NES, yend = Description), linewidth = 0.7, color = "grey60") +
  # Filled points
  geom_point(aes(fill = Direction), shape = 21, size = 4.5, color = NA) +
  # Black outline
  geom_point(aes(fill = Direction), shape = 21, size = 4.5, color = "black", stroke = 1.4) +
  scale_fill_manual(
    values = c("Up" = "red3", "Down" = "blue3"),
    breaks = c("Up", "Down"),
    labels = c(
      "Up" = "Upregulated in Definite LRTI",
      "Down" = "Downregulated in Definite LRTI"
    ),
    name = NULL
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    legend.justification = "left",
    legend.text = element_text(size = 11),
    legend.key.width = unit(1.2, "lines"),
    axis.text.y = element_text(size = 8),
    plot.title.position = "plot",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    plot.margin = ggplot2::margin(t = 10, r = 40, b = 10, l = 10)
  ) +
  labs(
    title = "Hallmark Pathway Enrichment (Protein GSEA)",
    subtitle = "Top significant Hallmark pathways",
    x = "Normalized Enrichment Score (NES)",
    y = NULL
  ) +
  xlim(-1, 4)

# Show plot
p_hallmark_all_prot

# Save plot
ggsave(
  filename = file.path(results_dir, "GSEA_Hallmark_protein.png"),
  plot = p_hallmark_all_prot,
  width = 8,
  height = 6,  
  dpi = 300
)






# 9.8. Reactome GSEA summary dot plot


# Prepare Reactome plot data
reactome_plot_prot_df <- gsea_reactome_prot@result %>%
  filter(p.adjust < 0.05) %>%
  mutate(
    neglogPadj = -log10(p.adjust),
    Direction = ifelse(NES > 0, "Up", "Down")
  )

# Top 8 Up
reactome_top_up_prot <- reactome_plot_prot_df %>%
  filter(NES > 0) %>%
  arrange(desc(NES)) %>%
  slice_head(n = 8)

# Top 8 Down
reactome_top_down_prot <- reactome_plot_prot_df %>%
  filter(NES < 0) %>%
  arrange(NES) %>%
  slice_head(n = 8)

reactome_top16_prot <- bind_rows(reactome_top_up_prot, reactome_top_down_prot) %>%
  mutate(
    Description = gsub("^REACTOME_", "", Description),
    Description = gsub("_", " ", Description),
    Description = str_wrap(Description, width = 40),
    Description = factor(Description, levels = Description[order(NES)])
  )

# Plot Reactome protein top 16
p_reactome_top16_prot <- ggplot(
  reactome_top16_prot,
  aes(y = Description, x = NES)
) +
  geom_vline(xintercept = 0, linewidth = 0.8, color = "black") +
  geom_segment(aes(x = 0, xend = NES, yend = Description), linewidth = 0.7, color = "grey60") +
  # Filled points
  geom_point(aes(fill = Direction), shape = 21, size = 4.5, color = NA) +
  # Black outline
  geom_point(aes(fill = Direction), shape = 21, size = 4.5, color = "black", stroke = 1.4) +
  scale_fill_manual(
    values = c("Up" = "red3", "Down" = "blue3"),
    breaks = c("Up", "Down"),
    labels = c(
      "Up" = "Upregulated in Definite LRTI",
      "Down" = "Downregulated in Definite LRTI"
    ),
    name = NULL
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    legend.justification = "left",
    legend.text = element_text(size = 11),
    legend.key.width = unit(1.2, "lines"),
    axis.text.y = element_text(size = 7),
    plot.title.position = "plot",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    plot.margin = ggplot2::margin(t = 10, r = 40, b = 10, l = 10)
  ) +
  labs(
    title = "Reactome Pathway Enrichment (Protein GSEA)",
    subtitle = "Top Up & Down significant Reactome pathways",
    x = "Normalized Enrichment Score (NES)",
    y = NULL
  ) +
  xlim(-3, 4)

# Show plot
p_reactome_top16_prot

# Save plot
ggsave(
  filename = file.path(results_dir, "GSEA_Reactome_protein.png"),
  plot = p_reactome_top16_prot,
  width = 8,
  height = 6,  
  dpi = 300
)





```
