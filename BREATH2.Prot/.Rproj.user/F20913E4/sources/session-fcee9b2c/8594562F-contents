---
title: "06-random_forest"
output: html_notebook
toc: true
---

```{r}
#| warning: false






# 6.1. Import Data for RF


library(dplyr)
library(magrittr)
library(randomForest)
library(tibble)

# Set file paths
data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Prot/data"
results_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Prot/results"

set.seed(8634782)

# Import data
patient_info_with_folds <- read.csv(
  file.path(data_dir, "patient_info_with_folds.csv"),
  stringsAsFactors=F)

protein_mat <- read.csv(
  file.path(data_dir, "protein_mat.csv"), 
  stringsAsFactors=F, row.names=1, check.names=F)

Parameters <- read.csv(
  file.path(data_dir, "parameters.csv"),
  stringsAsFactors=F, row.names=1)

# Define ntrees 
ntrees <- as.numeric(Parameters["RF Trees", "Count"])

# Convert patient_id to character
patient_info_with_folds$patient_id <- as.character(patient_info_with_folds$patient_id)

# Import selected proteins
lasso_fold_coefs <- read.csv(
  file.path(results_dir, "lasso_fold_coefs.csv"), 
  stringsAsFactors=F)

selected_lasso_coefs <- lasso_fold_coefs






# 6.2. RF function


# Outcome variable
y <- as.factor(patient_info_with_folds$LRTI_adjudication)  

# Function to run Random Forest for one outer CV fold
lassoRF_cv_outer_fold <- function(test_fold) {
  
  # Extract proteins selected by LASSO for this fold
  keep <- selected_lasso_coefs %>%
            filter(fold == test_fold) %>%
            .$protein
  
  # Subset protein matrix to selected proteins; rows = samples, columns = selected proteins
  X <- protein_mat[, keep, drop = FALSE]  
  
  # Boolean for training samples
  train <- patient_info_with_folds$fold != test_fold
  
  # Fit Random Forest (10000 Trees)
  rf <- randomForest(X[train, , drop = FALSE], y[train], ntree = ntrees)
  
  # Predictions on test fold
  preds <- predict(rf, newdata = X[!train, , drop = FALSE], type = "prob")[, "Definite"]
  
  list(test_fold = test_fold, mod = rf, pred = preds)
}

# Run RF across all folds
cv_list <- lapply(1:max(patient_info_with_folds$fold), lassoRF_cv_outer_fold)

# Ensure correct format
patient_info_with_folds <- as.data.frame(patient_info_with_folds)






# 6.3. Collect preds


# Collect out-of-fold predictions for all samples
rf_preds <- cv_list %>%
  lapply(function(x) {
    data.frame(
      patient_id = rownames(protein_mat)[patient_info_with_folds$fold == x$test_fold],
      pred = x$pred
    )
  }) %>%
  bind_rows() %>%
  dplyr::left_join(dplyr::select(patient_info_with_folds, patient_id, LRTI_adjudication), 
            by = "patient_id") %>%
  dplyr::relocate(LRTI_adjudication, .after = patient_id)

# Save RF predictions
write.csv(rf_preds, 
          file.path(results_dir, "lassoRF_preds.csv"),
          row.names=F)






# 6.4. Collect votes


# Collect RF votes (training set OOB probabilities)
rf_votes <- cv_list %>%
  lapply(function(x) {
    as.data.frame(x$mod$votes) %>%
      tibble::rownames_to_column("patient_id") %>%
      mutate(test_fold = x$test_fold) %>%
      rename(pred = Definite) %>%
      dplyr::select(test_fold, patient_id, pred)
  }) %>%
  bind_rows() %>%
  dplyr::left_join(dplyr::select(patient_info_with_folds, patient_id, LRTI_adjudication), 
            by = "patient_id") %>%
  dplyr::relocate(LRTI_adjudication, .after = patient_id)

# Save votes
write.csv(rf_votes, 
          file.path(results_dir, "lassoRF_votes.csv"),
          row.names=F)






# 6.5. Safety Check


# Summary
table(selected_lasso_coefs$protein)

all(selected_lasso_coefs$protein %in% colnames(protein_mat)) # Should return TRUE

nrow(rf_preds) == nrow(patient_info_with_folds) # Should return TRUE






```