---
title: "04-fold_assignment"
output: html_notebook
toc: true
---

```{r}
#| warning: false






# 4.1. Import patient info


library(dplyr)
library(rsample)
library(magrittr)

# Set file paths
data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Prot/data"

# Read csvs
patient_info <- read.csv(
  file.path(data_dir, "patient_info.csv"), 
  stringsAsFactors=F)

Parameters <- read.csv(
  file.path(data_dir, "parameters.csv"),
  stringsAsFactors=F, row.names=1)

# Define number of folds
nfolds <- as.numeric(Parameters["Folds", "Count"])

# Define number of No Evidence patients
No_Evidence <- as.numeric(Parameters["No Evidence", "Count"])

# Minimum required per fold
min_NE_per_fold <- floor(No_Evidence / nfolds)







# 4.2. Fold Assignment Using rsample


# Retry until constraints satisfied
folds_ok <- FALSE

# Set seed
set.seed(8634782)

# While loop
while (!folds_ok) {

  # Stratified vfold_cv using rsample
  vfold_obj <- vfold_cv(
    data = patient_info,
    v = nfolds,
    strata = "LRTI_adjudication"
  )

  # Create a data frame that maps each row to a fold
  patient_info_with_folds <- patient_info %>%
    mutate(fold = NA_integer_)

  # Fill in fold assignments
  for (i in seq_len(nfolds)) {
    fold_indices <- vfold_obj$splits[[i]]$in_id
    val_indices <- setdiff(seq_len(nrow(patient_info)), fold_indices)
    patient_info_with_folds$fold[val_indices] <- i
  }

  # Check how many No Evidence cases per fold
  counts <- table(
    patient_info_with_folds$fold,
    patient_info_with_folds$LRTI_adjudication
  )

  if (all(counts[, "No Evidence"] >= min_NE_per_fold)) {
    folds_ok <- TRUE
  }
}

# Save output
write.csv(
  patient_info_with_folds,
  file.path(data_dir, "patient_info_with_folds.csv"),
  row.names=F)






# 4.3. Safety Check


print(counts)

print(min_NE_per_fold)






```