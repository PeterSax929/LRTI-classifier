---
title: "02-fold_assignment"
output: html_notebook
toc: true
---

```{r}
#| warning: false






# 2.1. Import metadata


library(dplyr)
library(rsample)
library(magrittr)

data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/data"

# Read csvs
metadata_df <- read.csv(
  file.path(data_dir, "metadata_df.csv"), 
  stringsAsFactors=F)

Parameters <- read.csv(
  file.path(data_dir, "parameters.csv"),
  stringsAsFactors=F, row.names=1)

# Number of folds
nfolds <- as.numeric(Parameters["Folds", "Count"])

# Number of No Evidence patients
No_Evidence <- as.numeric(Parameters["No Evidence", "Count"])

# Minimum required per fold
min_NE_per_fold <- floor(No_Evidence / nfolds)






# 2.2. Fold Assignment Using rsample


folds_ok <- FALSE

# Set seed
set.seed(8634782)

# While loop enforcing constraints
while (!folds_ok) {

  # Stratified k-fold CV
  vfold_obj <- vfold_cv(
    data = metadata_df,
    v = nfolds,
    strata = "LRTI_adjudication"
  )

  # Add placeholder fold column (will be last column)
  metadata_df_with_folds <- metadata_df %>%
    mutate(fold = NA_integer_)

  # Fill fold assignments
  for (i in seq_len(nfolds)) {
    fold_indices <- vfold_obj$splits[[i]]$in_id
    val_indices <- setdiff(seq_len(nrow(metadata_df)), fold_indices)
    metadata_df_with_folds$fold[val_indices] <- i
  }

  # Count how many No Evidence cases per fold
  counts <- table(
    metadata_df_with_folds$fold,
    metadata_df_with_folds$LRTI_adjudication
  )

  # Check constraint
  if (all(counts[, "No Evidence"] >= min_NE_per_fold)) {
    folds_ok <- TRUE
  }
}

# Save output
write.csv(metadata_df_with_folds,
  file.path(data_dir, "metadata_df_with_folds.csv"),
  row.names=F)






# 2.3. Safety Check


print(counts)

print(min_NE_per_fold)






```