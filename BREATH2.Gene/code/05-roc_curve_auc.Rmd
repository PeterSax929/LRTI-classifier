---
title: "05-roc_curve_auc"
output: html_notebook
toc: true
---

```{r}
#| warning: false


library(dplyr)
library(magrittr)
library(pROC)






# 5.1. Import metadata & preds


data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/data"
results_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/results"

# Import fold assignments
metadata_df_with_folds <- read.csv(
  file.path(data_dir, "metadata_df_with_folds.csv"),
  stringsAsFactors=F)

# Import out-of-fold predictions
lassoRF_preds <- read.csv(
  file.path(results_dir, "lassoRF_preds.csv"),
  stringsAsFactors=F)

# Ensure consistent factor levels
lassoRF_preds$LRTI_adjudication <- factor(
  lassoRF_preds$LRTI_adjudication,
  levels = c("No Evidence", "Definite"))

# Merge
merged_preds <- lassoRF_preds %>%
  dplyr::inner_join(metadata_df_with_folds %>% 
  dplyr::select(sample_name, fold),
    by = "sample_name")






# 5.2. Per-fold AUC


output_auc_roc <- function(preds_df, output_suffix) {

  # Compute per-fold AUC
  auc_df <- preds_df %>%
    group_by(fold) %>%
    summarize({
    roc_obj <- pROC::roc(
    response  = factor(LRTI_adjudication, levels = c("No Evidence", "Definite")),
    predictor = pred,
    direction = "<"
  )
  ci_vals <- pROC::ci.auc(roc_obj, conf.level = 0.95)
  tibble(
    auc = as.numeric(roc_obj$auc),
    auc_lower = ci_vals[1],
    auc_upper = ci_vals[3]
  )
}, .groups = "drop")

  # Determine number of folds
  max_fold <- max(auc_df$fold)

  # Create ROC PDF (all folds overlayed)
  pdf(file.path(results_dir, paste0("ROC_", output_suffix, ".pdf")))

  for (i in 1:max_fold) {
    fold_data <- preds_df %>% filter(fold == i)

    roc_obj <- pROC::roc(
      response  = factor(fold_data$LRTI_adjudication, levels = c("No Evidence", "Definite")),
      predictor = fold_data$pred,
      direction = "<"
    )

    plot(roc_obj, add = (i != 1), col = i)
  }

  dev.off()

  # Save per-fold AUC CSV at the very end
  write.csv(
    auc_df,
    file.path(results_dir, paste0("cv_auc_", output_suffix, ".csv")),
    row.names=F)

  return(auc_df)
}






# 5.3. Plot Graph


# Run AUC computation
auc_lassoRF <- output_auc_roc(merged_preds, "lassoRF")

max_fold <- max(auc_lassoRF$fold)

# Open empty plot for overlay with top-left orientation
plot(0, 0, type = "n",
     xlim = c(1, 0), ylim = c(0, 1),
     xlab = "Specificity", ylab = "Sensitivity",
     main = "ROC Curves by Fold")

# Add diagonal reference
lines(x = c(1, 0), y = c(0, 1), lty = 2, col = "gray")

for (i in 1:max_fold) {
  fold_data <- merged_preds %>% filter(fold == i)

  roc_obj <- pROC::roc(
    response  = factor(fold_data$LRTI_adjudication, levels = c("No Evidence", "Definite")),
    predictor = fold_data$pred,
    direction = "<"
  )

  # Plot specificity directly: axis direction flips via xlim
  lines(roc_obj$specificities, roc_obj$sensitivities, col = i, lwd = 2)
}

legend("bottomright", legend = paste("Fold", 1:max_fold), col = 1:max_fold, lwd = 2)






# 5.4. Summaries


# DeLong 95% CI for overall ROC
ci_auc <- pROC::ci.auc(
  pROC::roc(
    response = factor(merged_preds$LRTI_adjudication, 
    levels = c("No Evidence", "Definite")),
    predictor = merged_preds$pred,
    direction = "<"
  ),
  conf.level = 0.95
)

message("Lower AUC: ", round(ci_auc[1], 3))
message("Mean AUC: ", round(as.numeric(ci_auc[2]), 3))
message("Upper AUC: ", round(ci_auc[3], 3))

print(auc_lassoRF)






```