---
title: "08-rna_protein_loglog_plot"
output: html_notebook
toc: true
---

```{r}
#| warning: false






# 8.1. Import data


library(dplyr)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(tibble)

data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/data"
results_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/results"

# RNA vst matrix (genes x samples)
full_vsd <- read.csv(
  file.path(data_dir, "vst_combined_per_fold.csv"),
  row.names=1)

# Protein log2-normalized abundances matrix (samples x proteins)
protein_mat <- read.csv(
  "C:/Users/User/Documents/UCSF/BREATH2.Prot/data/protein_mat.csv",
  row.names=1)






# 8.2. Prepare RNA


rna_mean <- full_vsd %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  mutate(gene_symbol = ensg2gene[gene]) %>%
  mutate(gene_symbol = ifelse(is.na(gene_symbol), gene, gene_symbol)) %>%
  dplyr::select(-gene) %>%
  pivot_longer(
    cols = -gene_symbol,
    names_to = "sample_name",
    values_to = "expr_vst"
  ) %>%
  group_by(gene_symbol) %>%
  summarize(
    mean_rna_vst = mean(expr_vst, na.rm = TRUE),
    .groups = "drop"
  )






# 8.3. Prepare protein


protein_mean <- protein_mat %>%
  as.data.frame() %>%
  rownames_to_column("patient_id") %>%
  pivot_longer(
    cols = -patient_id,
    names_to = "gene_symbol",
    values_to = "protein_log2"
  ) %>%
  group_by(gene_symbol) %>%
  summarize(
    mean_protein_log2 = mean(protein_log2, na.rm = TRUE),
    .groups = "drop"
  )




# 8.4. Merge RNA with protein


rna_mean <- rna_mean %>% distinct(gene_symbol, .keep_all = TRUE)
protein_mean <- protein_mean %>% distinct(gene_symbol, .keep_all = TRUE)

loglog_df <- inner_join(
  rna_mean,
  protein_mean,
  by = "gene_symbol"
)

# Identify top genes by combined mean abundance (RNA + protein)
label_df <- loglog_df %>%
  mutate(total_abundance = mean_rna_vst + mean_protein_log2) %>%
  arrange(desc(total_abundance)) %>%
  head(20)   # top 20 most abundant genes

# Correlation
cor_spearman <- cor(
  loglog_df$mean_rna_vst,
  loglog_df$mean_protein_log2,
  method = "spearman"
)






# 8.5. Log-log abundance plot


ggplot(
  loglog_df,
  aes(x = mean_rna_vst, y = mean_protein_log2)
) +
  geom_point(alpha = 0.25, size = 1, color = "grey30") +
  geom_smooth(method = "lm", se = FALSE, color = "firebrick", linewidth = 0.8) +
  geom_text_repel(
  data = label_df,
  aes(label = gene_symbol),
  size = 3,
  max.overlaps = 20,
  box.padding = 0.4,
  segment.color = "grey70"
) +
  theme_classic() +
  labs(
    x = "Mean RNA expression (VST)",
    y = "Mean protein abundance (log2)",
    title = "RNAâ€“Protein Abundance Relationship",
    subtitle = paste0(
      "Spearman \u03C1 = ", round(cor_spearman, 2),
      " | n = ", nrow(loglog_df)
    )
  )

ggsave(
  file.path(results_dir, "RNA_protein_loglog_abundance.png"),
  width = 7,
  height = 6
)






```