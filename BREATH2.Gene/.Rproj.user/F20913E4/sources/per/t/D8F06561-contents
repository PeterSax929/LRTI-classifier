---
title: "04-random_forest"
output: html_notebook
toc: true
---

```{r}
#| warning: false






# 4.1. Import Data for RF


library(dplyr)
library(magrittr)
library(randomForest)
library(tibble)
library(DESeq2)    
library(SummarizedExperiment)

data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/data"
results_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/results"

set.seed(8634782)

# Import data
metadata_df_with_folds <- read.csv(
  file.path(data_dir, "metadata_df_with_folds.csv"),
  stringsAsFactors=F)

full_vsd <- read.csv(
  file.path(data_dir, "vst_combined_per_fold.csv"),
  stringsAsFactors=F, row.names=1)

Parameters <- read.csv(
  file.path(data_dir, "parameters.csv"),
  stringsAsFactors=F, row.names=1)

# Define ntrees 
ntrees <- as.numeric(Parameters["RF Trees", "Count"])

# Import selected proteins
lasso_fold_coefs <- read.csv(
  file.path(results_dir, "lasso_fold_coefs.csv"), 
  stringsAsFactors=F)

# Use lasso_fold_coefs as selected genes
selected_lasso_coefs <- lasso_fold_coefs






# 4.2. RF function


# Outcome variable
y <- as.factor(metadata_df_with_folds$LRTI_adjudication)  

# Function to run Random Forest for one outer CV fold
lassoRF_cv_outer_fold <- function(test_fold) {
  
  # Extract proteins selected by LASSO for this fold
  keep <- selected_lasso_coefs %>%
            filter(fold == test_fold) %>%
            .$gene

  # Boolean for training samples
  train <- metadata_df_with_folds$fold != test_fold
  test  <- metadata_df_with_folds$fold == test_fold

  
  
  
  
  
# 4.2a. Use precomputed vst from LASSO
  
  
# full_vsd is genes x samples â€” transpose to samples x genes
X_all <- t(as.matrix(full_vsd))

# Ensure X_all row order matches metadata order
X_all <- X_all[metadata_df_with_folds$sample_name, , drop = FALSE]

# training / test matrices
X_train <- X_all[train, keep, drop = FALSE]
X_test  <- X_all[test, keep, drop = FALSE]

stopifnot(all(colnames(X_train) %in% selected_lasso_coefs$gene))

  # Fit Random Forest (10000 Trees)
  rf <- randomForest(X_train, y[train], ntree = ntrees)
  
  # Predictions on test fold
  preds <- predict(rf, newdata = X_test, type = "prob")[, "Definite"]
  
  list(test_fold = test_fold, mod = rf, pred = preds)
}

# Run RF across all folds
cv_list <- lapply(1:max(metadata_df_with_folds$fold), lassoRF_cv_outer_fold)






# 4.3. Collect preds


# Collect out-of-fold predictions for all samples
rf_preds <- cv_list %>%
  lapply(function(x) {
    data.frame(
      sample_name = metadata_df_with_folds$sample_name[
        metadata_df_with_folds$fold == x$test_fold],
      pred = x$pred
    )
  }) %>%
  bind_rows() %>%
  dplyr::left_join(
  dplyr::select(metadata_df_with_folds, sample_name, LRTI_adjudication),
    by = "sample_name"
  ) %>%
  dplyr::relocate(LRTI_adjudication, .after = sample_name)

# Save RF predictions
write.csv(rf_preds, 
          file.path(results_dir, "lassoRF_preds.csv"),
          row.names=F)






# 4.4. Collect votes


# Collect RF votes (training set OOB probabilities)
rf_votes <- cv_list %>%
  lapply(function(x) {
    as.data.frame(x$mod$votes) %>%
      tibble::rownames_to_column("sample_name") %>%
      mutate(test_fold = x$test_fold) %>%
      mutate(pred = .data[["Definite"]]) %>%
      dplyr::select(test_fold, sample_name, pred)
  }) %>%
  bind_rows() %>%
  dplyr::left_join(
  dplyr::select(metadata_df_with_folds, sample_name, LRTI_adjudication),
    by = "sample_name"
  ) %>%
  dplyr::relocate(LRTI_adjudication, .after = sample_name)

# Save votes
write.csv(rf_votes, 
          file.path(results_dir, "lassoRF_votes.csv"),
          row.names=F)






# 4.5. Safety Check


# Summary
table(selected_lasso_coefs$gene_symbol)

nrow(rf_preds) == nrow(metadata_df_with_folds) # Should return TRUE






```